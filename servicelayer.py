from flask import Flask
from flask import jsonify
from dblayer import DBLayer
from flask import request

app = Flask(__name__)


@app.route('/all/malwares/', methods=['GET'])
def getAllBlackListUrls():
    s1 = DBLayer.getInstance()
    records = s1.fetch_blacklist_urls()
    return jsonify({'records': list(records)})


def checkWhetherMalwareURL(url_id, host, port, url_path, qstring):
    db_conn = DBLayer.getInstance()
    records = db_conn.fetch_blacklist_urls()
    for record in records:
        print(record)
        if url_id == record[0]:
            if host == record[1]:
                if port == record[2]:
                    if url_path == record[3]:
                        if qstring.decode("utf-8") == record[4]:
                            return True
    return False


@app.route('/urlinfo/<int:url_id>/<host_port>/<path:url_path>', methods=['GET'])
def isMalwareUrl(url_id, host_port, url_path):
    (host, port) = host_port.split(":")
    port = int(port)
    if url_id is None or host is None or port is None or url_path is None:
        return jsonify({'error': 'incomplete or invalid url...'})

    # port range check
    if not (0 <= port and port <= 65535):
        return jsonify({'error': 'invalid port range...'})

    is_malware = checkWhetherMalwareURL(url_id, host, port, url_path, request.query_string)
    url_info = {
        'url_id': url_id,
        'is_malware': is_malware
    }
    return jsonify(url_info)


@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def catch_all(path):
    msg = 'Invalid url %s...' % path
    return jsonify({'error': msg})


if __name__ == "__main__":
    app.run()