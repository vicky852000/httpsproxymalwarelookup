import sys
import urllib.request

from constants import *
from logger import CallerLogs
logger = CallerLogs.createCallerLogger()

def callServiceLayer(url_lst=[], dct={}):
    '''
    Call service layer for all the Urls received in the list and update the dictionary
    '''
    for url in url_lst:
        try:
            resp = urllib.request.urlopen(url)
            info = resp.read()
            if info:
                logger.info("received data from service layer")
                info = eval(info)
            else:
                logger.error("couldn't receive data from service layer")
                raise Exception("did not receive any information from server")

            if ERROR in info:
                logger.error("service layer reported error {0} for {1}".format(info.get(ERROR), url))
                dct['urls'].append({
                    'url_link': url,
                    'error' : True,
                    'desc'  : info.get(ERROR)
                })
            else:
                dct['urls'].append({
                    'is_malware': info.get(IS_MALWARE),
                    'url_id'    : info.get(URL_ID),
                    'url_link'  : url,
                    'error': False,
                })
        except Exception as e:
            logger.error("some exception occurred due to {}"+ str(e))


def getMemorySize():
    '''
    This method will return the memory which is available in the system.
    we are doing this as our url list can grow in size beyond the system memory available.

    Ideally this should use psutil library which have to be installed, however here I am assuming only 1 mb space is available to load the data from file
    '''
    available_memory = 1 # psutil.virtual_memory(), Assuming worst case. only 1 MB is available to load
    can_use_memory = available_memory*1024
    logger.info("available memory limit {0} bytes".format(can_use_memory))
    return can_use_memory #converting it to bytes



def openFileAndLoadUrls(FILENAME,dct={}):
    '''
    This method will check the available system memory and load appropriate urls only in memory to avoid crash due to OutOfMemoryException
    Here
        1. fetch available memory from system
        2. then start loading the urls till they are less than current available memory. Here for safer side I am storing 200 bytes less. We can still enhance this
        3. Once the load is done means near to the available memory limit then call service layer api's to check whether that are malware sites.
        4. Check for url list is also required as you may still have some memory but all the Url's are done. In that case we case to accomodate that much Urls and call
            service layer.
    '''
    available_memory = getMemorySize()
    lines = []
    f_open = open(FILENAME, 'r')
    avl_memory = available_memory
    while True:
        try:
            line = f_open.readline()
            line_size = sys.getsizeof(line)
            avl_memory -= line_size

            #Each url size is approximatly 128bytes so on safer side comparing it with 200, we have to handle it based on next line
            if avl_memory < 200 or not line:
                #we have loaded limited urls in the list, loading beyond that may crash the system.
                logger.info("calling service layer for {0}".format(lines))
                callServiceLayer(lines,dct)

                # Reseting temorary memory variable
                avl_memory = available_memory
                #Reseting the list which contains the processed urls
                lines = []

                #may be there is still some space in the memory but we are done with the urls. So we are done breaking the loop
                if not line:
                    break

            #adding next line in the processing list.
            lines.append(line.rstrip())
        finally:
            f_open.close()

if __name__ == "__main__":
    logger.info("service caller started")
    dct = {}
    dct['urls'] = []
    openFileAndLoadUrls(FILENAME,dct)
    logger.info("output received is {0}".format(dct));
    logger.info("service caller exited")

